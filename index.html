<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ExamSim Web — Endless Mode</title>
<script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
<style>
  :root {
    --bg:#0f1116; --panel:#111827; --fg:#e5e7eb; --sub:#cbd5e1; --accent:#2563eb;
    --muted:#1f2937; --select:#0b1220; --green:#22c55e; --red:#ef4444;
  }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font:16px/1.4 "Segoe UI",system-ui,-apple-system,sans-serif}
  .wrap{max-width:1100px;margin:0 auto;padding:20px}
  .topbar{display:flex;gap:12px;align-items:center;margin-bottom:14px}
  h1{font-size:22px;margin:0 12px 0 0}
  .btn{background:var(--accent);color:#fff;border:none;border-radius:10px;padding:10px 16px;cursor:pointer}
  .btn.secondary{background:#374151}
  .exam-title{color:var(--sub);font-weight:600}
  .panel{background:var(--panel);border:1px solid var(--muted);border-radius:14px;margin:12px 0}
  .panel .head{padding:14px 16px 6px 16px;font-weight:700}
  .q{padding:10px 16px 14px 16px;border-top:1px solid var(--muted)}
  .q:first-child{border-top:none}

  /* TITLE ABOVE, BAR BELOW */
  .qtitle{font-weight:600;margin-bottom:6px}
  .accRow{display:flex;justify-content:flex-end;gap:8px;margin:2px 0 8px}
  @media (max-width:700px){ .accRow{justify-content:flex-start} }

  .choices .row{display:flex; align-items:center; gap:10px; margin:8px 0}
  .choices input[type="radio"], .choices input[type="checkbox"]{transform:translateY(1px)}
  .choices label{color:var(--sub); cursor:pointer}

  textarea{width:100%;min-height:110px;background:var(--bg);color:var(--fg);border:1px solid var(--muted);border-radius:8px;padding:8px;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
  textarea.error{border-color:var(--red); box-shadow:0 0 0 2px color-mix(in srgb, var(--red) 20%, transparent)}
  select{background:var(--panel);color:var(--fg);border:1px solid var(--muted);border-radius:8px;padding:4px}
  .legend{color:var(--sub);font-size:13px;margin:6px 0 8px}
  .row{display:flex;gap:12px;align-items:center;margin:6px 0}
  .explain{display:none;margin-top:8px;color:#94a3b8}
  .foot{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-top:1px solid var(--muted)}
  .score{font-weight:700}
  .mark{color:#94a3b8;font-size:13px}
  .q.correct .qtitle{color:var(--green)}
  .q.wrong .qtitle{color:var(--red)}
  .hint{background:#0b1220;border:1px dashed #1f2a44;border-radius:10px;padding:8px 10px;margin-top:8px;color:#a5b4fc}
  .controls{display:flex;gap:10px;flex-wrap:wrap}
  input[type="file"]{display:none}
  .filebtn{background:#1f2937;color:#e5e7eb;border:1px solid #374151;padding:8px 12px;border-radius:8px;cursor:pointer}
  a.dl{color:#93c5fd;text-decoration:none}
  .small{font-size:13px;color:#9ca3af}
  .status{font-size:13px;margin-left:6px}

  /* accuracy bar */
  .acc{display:flex; align-items:center; gap:8px; min-width:220px}
  .acc .bar{width:160px;height:8px;background:var(--muted);border-radius:999px;overflow:hidden;display:flex}
  .acc .g{height:100%;background:var(--green);width:0%}
  .acc .r{height:100%;background:var(--red);width:100%}
  .acc .txt{font-size:12px;color:var(--sub);min-width:70px;text-align:right}
  .acc.hide{display:none}
  .pill{padding:2px 8px;border-radius:999px;background:#0b1220;border:1px solid #243145;color:#a5b4fc;font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <h1>ExamSim Web</h1>
    <div class="exam-title" id="examName">— no exam loaded</div>
  </div>

  <div class="panel">
    <div class="head">Load exam</div>
    <div class="q">
      <div class="controls">
        <label class="filebtn">Choose YAML… <input id="fileInput" type="file" accept=".yml,.yaml" /></label>
        <button class="btn secondary" id="demoBtn">Load sample</button>
        <button class="btn secondary" id="exam5Btn">Load Exam5</button>
        <span class="small">Paste or pick a YAML that follows desktop ExamSim.</span>
      </div>
    </div>
    <div class="q">
      <div class="legend">Or paste YAML below</div>
      <textarea id="yamlPaste" placeholder="Paste ExamSim YAML here…"></textarea>
      <div class="controls">
        <button class="btn" id="loadFromTextBtn">Load from text</button>
        <button class="btn secondary" id="saveTextBtn">Download pasted YAML</button>
        <span id="pasteStatus" class="status small"></span>
      </div>
    </div>
  </div>

  <!-- Study settings -->
  <div class="panel" id="settingsPanel" style="display:none;">
    <div class="head">Study settings</div>
    <div class="q">
      <div class="controls">
        <label>Iterations:
          <input id="iterInput" type="number" min="1" step="1" value="3" style="width:80px;margin-left:6px;background:var(--panel);color:var(--fg);border:1px solid var(--muted);border-radius:8px;padding:6px">
        </label>
        <label style="display:flex;align-items:center;gap:6px;">
          <input id="accToggle" type="checkbox" checked> Show Accuracy
        </label>
        <button class="btn secondary" id="shuffleBtn" title="Rebuild and reshuffle with current settings">Shuffle now</button>
        <button class="btn" id="applyBtn" title="Save settings and rebuild">Apply</button>
        <span id="counts" class="pill">Base: — • Iter: 3 • Rendered: —</span>
      </div>
      <div class="small">Each question is duplicated <b>Iterations</b> times, then the whole set is shuffled.</div>
    </div>
  </div>

  <div id="examContainer" class="panel" style="display:none;">
    <div class="head" id="examHeader"></div>
    <div id="qList"></div>
    <div class="foot">
      <div class="score" id="scoreBox">Score: —</div>
      <div>
        <button class="btn" id="submitBtn">Submit</button>
        <button class="btn secondary" id="resetBtn">Reset</button>
      </div>
    </div>
  </div>

  <div id="tips" class="small">
    Tip: click the <b>?</b> on any question to grade just that item and show its explanation without submitting. That attempt counts toward accuracy.
  </div>
</div>

<script>
/* ---------- helpers ---------- */
const $ = sel => document.querySelector(sel);
const el = (tag, cls) => { const e = document.createElement(tag); if (cls) e.className = cls; return e; };
const shuffle = arr => { for (let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]] } return arr; };
function dl(filename, text) {
  const blob = new Blob([text], {type: "text/plain;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 4000);
}
function toBool(v){ if (typeof v === "boolean") return v; if (typeof v === "string") return v.trim().toLowerCase().startsWith("t"); return false; }
function hashStr(s){ let h=0; for (let i=0;i<s.length;i++){ h=(h<<5)-h + s.charCodeAt(i); h|=0; } return ("00000000"+(h>>>0).toString(16)).slice(-8); }

/* ---------- globals ---------- */
let BASE_QUESTIONS = [];
let QUESTIONS = [];
let RENDER = [];
let EXAM_NAME = "Exam";
let SETTINGS = { iterations: 3, showAccuracy: true };
const LS_SETTINGS = "examsim_settings_v2";
const PASTE_KEY = "examsim_yaml_paste";
let ACCURACY = {};
let BAR_REGISTRY = {};

/* ---------- accuracy persistence ---------- */
const accKey = () => "examsim_acc_"+EXAM_NAME;
function loadAccuracy(){ try{ ACCURACY = JSON.parse(localStorage.getItem(accKey())||"{}"); }catch{ ACCURACY={}; } }
function saveAccuracy(){ localStorage.setItem(accKey(), JSON.stringify(ACCURACY)); }
function getAcc(baseId){ return ACCURACY[baseId] || {c:0,t:0}; }
function recordAttempt(baseId, correct){
  const rec = ACCURACY[baseId] || {c:0,t:0};
  rec.t += 1; if (correct) rec.c += 1;
  ACCURACY[baseId] = rec; saveAccuracy(); updateAccBar(baseId);
}
function updateAccBar(baseId){
  const rec = getAcc(baseId);
  const pct = rec.t ? Math.round((rec.c/rec.t)*100) : 0;
  const greenW = rec.t ? (rec.c/rec.t)*100 : 0;
  const redW   = 100 - greenW;
  const pack = BAR_REGISTRY[baseId] || {bars:[],txts:[]};
  pack.bars.forEach(([g,r])=>{ g.style.width = greenW+"%"; r.style.width = redW+"%"; });
  pack.txts.forEach(t=> t.textContent = `${pct}% (${rec.c}/${rec.t})`);
}

/* ---------- load & normalize ---------- */
function normalizeQuestion(q){
  const t = q.type;
  const base = { type:t, text: String(q.text||"").trim(), explain: (q.explain ?? "").toString() };
  if (t === "TrueFalse") return { ...base, answer: toBool(q.answer) };
  if (t === "MultiChoice"){
    const ch = q.choices||{};
    return { ...base, choices: ch, answer: String(q.answer||"").toUpperCase() };
  }
  if (t === "MultiSelect"){
    const ch = q.choices||{};
    let ans = q.answer ?? [];
    if (typeof ans === "string") ans = [ans];
    ans = ans.map(s => String(s).toUpperCase()).sort();
    return { ...base, choices: ch, answer: ans };
  }
  if (t === "Matching"){ return { ...base, pairs: q.pairs, options: q.options, answer: q.answer }; }
  if (t === "ShortAnswer" || t === "ProblemScen"){ return { ...base, answer: "" }; }
  throw new Error("Unsupported type: " + t);
}

function loadYAML(text, name="Exam"){
  let data;
  try{
    data = jsyaml.load(text);
    if (!Array.isArray(data)) throw new Error("Top-level YAML must be a list of question objects.");
  }catch(e){
    alert("YAML parse error:\n" + e.message);
    return;
  }
  BASE_QUESTIONS = data.map(normalizeQuestion).map(q=>{
    const id = hashStr(JSON.stringify(q));
    return { ...q, baseId:id };
  });
  EXAM_NAME = name.replace(/\.(yml|yaml)$/i,"");
  $("#examName").textContent = "— " + EXAM_NAME;
  $("#settingsPanel").style.display = "block";
  try{
    SETTINGS = JSON.parse(localStorage.getItem(LS_SETTINGS) || "{}");
    SETTINGS.iterations = Math.max(1, Number(SETTINGS.iterations||3));
    SETTINGS.showAccuracy = SETTINGS.showAccuracy !== false;
  }catch{ SETTINGS = {iterations:3, showAccuracy:true}; }
  $("#iterInput").value = SETTINGS.iterations;
  $("#accToggle").checked = SETTINGS.showAccuracy;

  loadAccuracy();
  buildDeck();
  renderExam();
}

function buildDeck(){
  $("#counts").textContent = `Base: ${BASE_QUESTIONS.length} • Iter: ${SETTINGS.iterations} • Rendered: ${BASE_QUESTIONS.length*SETTINGS.iterations}`;
  const base = shuffle([...BASE_QUESTIONS]);
  QUESTIONS = [];
  for (let k=0;k<SETTINGS.iterations;k++){
    base.forEach(q => QUESTIONS.push({ ...q, cloneOf:q.baseId, seq:k }));
  }
  shuffle(QUESTIONS);
}

/* ---------- render ---------- */
function renderExam(){
  RENDER = [];
  BAR_REGISTRY = {};
  $("#examContainer").style.display = "block";
  $("#examHeader").textContent = `${EXAM_NAME} — ${QUESTIONS.length} Questions (base ${BASE_QUESTIONS.length} × ${SETTINGS.iterations})`;
  $("#scoreBox").textContent = "Score: —";

  const qList = $("#qList");
  qList.innerHTML = "";

  QUESTIONS.forEach((q, idx) => {
    const qDiv   = el("div","q");

    // TITLE (line 1)
    const title  = el("div","qtitle");
    title.textContent = `${idx+1}. ${q.text}`;
    qDiv.appendChild(title);

    // ACCURACY (line 2)
    const accWrap = createAccUI(q.baseId);
    const accRow  = el("div","accRow");
    accRow.appendChild(accWrap.wrap);
    if (!SETTINGS.showAccuracy) accWrap.wrap.classList.add("hide");
    qDiv.appendChild(accRow);

    const area  = el("div","area"); qDiv.appendChild(area);

    const meta = { type:q.type, node:qDiv, titleNode:title, explain:q.explain, baseId:q.baseId, counted:false, instanceId: `${q.baseId}_${idx}_${Date.now()%1e6}` };

    if (q.type === "TrueFalse") {
      const choices = el("div","choices");
      [["T","True"],["F","False"]].forEach(([v,lab])=>{
        const id = `q${idx}_${v}`;
        const row = el("div","row");
        const r = el("input"); r.type="radio"; r.name=`q${idx}`; r.value=v; r.id=id;
        const L = el("label"); L.setAttribute("for", id); L.textContent=`${lab}`;
        row.appendChild(r); row.appendChild(L); choices.appendChild(row);
      });
      area.appendChild(choices);
      meta.getUser = () => {
        const sel = [...choices.querySelectorAll("input[type=radio]")].find(i=>i.checked);
        return sel ? sel.value : "";
      };
      meta.grade = () => {
        const val = meta.getUser(); const ans = q.answer ? "T" : "F";
        colorize(qDiv, val && val===ans);
        markChoicesABCD(choices, ans, val);
        return (val===ans) ? 1 : 0;
      };

    } else if (q.type === "MultiChoice") {
      const choices = el("div","choices");
      ["A","B","C","D"].forEach(letter=>{
        const id = `q${idx}_${letter}`;
        const row = el("div","row");
        const r = el("input"); r.type="radio"; r.name=`q${idx}`; r.value=letter; r.id=id;
        const L = el("label"); L.setAttribute("for", id);
        L.textContent = `${letter}. ${q.choices?.[letter] ?? ""}`;
        row.appendChild(r); row.appendChild(L); choices.appendChild(row);
      });
      area.appendChild(choices);
      meta.getUser = () => {
        const sel = [...choices.querySelectorAll("input[type=radio]")].find(i=>i.checked);
        return sel ? sel.value : "";
      };
      meta.grade = () => {
        const val = meta.getUser(); const ans = q.answer;
        colorize(qDiv, val && val===ans);
        markChoicesABCD(choices, ans, val);
        return (val===ans) ? 1 : 0;
      };

    } else if (q.type === "MultiSelect") {
      const choices = el("div","choices");
      ["A","B","C","D"].forEach(letter=>{
        const id = `q${idx}_${letter}`;
        const row = el("div","row");
        const c = el("input"); c.type="checkbox"; c.value=letter; c.id=id;
        const L = el("label"); L.setAttribute("for", id);
        L.textContent = `${letter}. ${q.choices?.[letter] ?? ""}`;
        row.appendChild(c); row.appendChild(L); choices.appendChild(row);
      });
      area.appendChild(choices);
      meta.getUser = () => ([...choices.querySelectorAll("input[type=checkbox]:checked")].map(i=>i.value).sort());
      meta.grade = () => {
        const picks = meta.getUser(); const ans = (q.answer||[]).slice().sort();
        const ok = JSON.stringify(picks)===JSON.stringify(ans);
        colorize(qDiv, ok);
        markChoicesMulti(choices, ans, picks);
        return ok ? 1 : 0;
      };

    } else if (q.type === "Matching") {
      const legend = el("div","legend");
      legend.textContent = "Options: " + ["A","B","C","D"].map(k=>`${k}: ${q.options[k]}`).join("    ");
      area.appendChild(legend);
      const rows = [];
      [1,2,3,4].forEach(n=>{
        const row = el("div","row");
        const left = el("div"); left.textContent = `${n}) ${q.pairs[n] || q.pairs[String(n)] || ""}`;
        const sel = el("select");
        ["","A","B","C","D"].forEach(k=>{ const o=el("option"); o.value=k; o.textContent=k||"—"; sel.appendChild(o); });
        row.appendChild(left); row.appendChild(sel); area.appendChild(row);
        rows.push({left, sel});
      });
      meta.getUser = () => { const m={}; [1,2,3,4].forEach((n,i)=> m[n] = rows[i].sel.value || ""); return m; };
      meta.grade = () => {
        const user = meta.getUser(); const ans = q.answer; let score=0;
        [1,2,3,4].forEach((n,i)=>{ const ok = (user[n] === (ans[n] || ans[String(n)])); rows[i].left.style.color = ok ? "var(--green)" : "var(--red)"; if (ok) score++; });
        colorize(qDiv, score===4); return score/4;
      };

    } else if (q.type === "ShortAnswer" || q.type === "ProblemScen") {
      const ta = el("textarea"); ta.placeholder = "Type your answer…";
      const mark = el("label","mark");
      const cb = el("input"); cb.type="checkbox"; cb.style.marginRight="6px";
      mark.appendChild(cb); mark.appendChild(document.createTextNode("Mark as correct (manual)"));
      area.appendChild(ta); area.appendChild(mark);
      meta.getUser = () => ({ text: ta.value.trim(), marked: cb.checked });
      meta.grade = () => { const u = meta.getUser(); const ok = !!u.marked; colorize(qDiv, ok); return ok ? 1 : 0; };
    }

    // explanation + peek
    const expl = el("div","explain");
    const hint = el("div","hint"); hint.textContent = q.explain || "(no explanation)";
    expl.appendChild(hint); area.appendChild(expl);

    const ctrl = el("div"); ctrl.style.display="flex"; ctrl.style.gap="10px"; ctrl.style.marginTop="8px";
    const peekBtn = el("button","btn secondary"); peekBtn.textContent = " ?"; peekBtn.title = "Grade this question and show the explanation (does not submit)";
    peekBtn.addEventListener("click", ()=>{
      const res = meta.grade();
      if (!meta.counted){ recordAttempt(meta.baseId, res >= 1); meta.counted = true; }
      expl.style.display = "block";
    });
    ctrl.appendChild(peekBtn); area.appendChild(ctrl);

    qList.appendChild(qDiv);
    RENDER.push(meta);

    updateAccBar(q.baseId);
  });

  $("#submitBtn").onclick = submitAll;
  $("#resetBtn").onclick = ()=>{ buildDeck(); renderExam(); };
}

function createAccUI(baseId){
  const wrap = el("div","acc");
  const bar  = el("div","bar");
  const g = el("div","g"), r = el("div","r");
  bar.appendChild(g); bar.appendChild(r);
  const txt  = el("div","txt"); txt.textContent = "0% (0/0)";
  wrap.appendChild(bar); wrap.appendChild(txt);
  const reg = BAR_REGISTRY[baseId] || {bars:[], txts:[]};
  reg.bars.push([g,r]); reg.txts.push(txt);
  BAR_REGISTRY[baseId] = reg;
  return {wrap, bar, g, r, txt};
}

/* ---------- mark helpers ---------- */
function colorize(node, ok){ node.classList.remove("correct","wrong"); node.classList.add(ok?"correct":"wrong"); }
function markChoicesABCD(container, ans, picked){
  container.querySelectorAll("label").forEach(l=>l.style.color="var(--sub)");
  container.querySelectorAll("input").forEach(i=>{
    const lab = container.querySelector(`label[for="${i.id}"]`);
    if (!lab) return;
    if (i.value===ans) lab.style.color="var(--green)";
    if (picked && i.value===picked && picked!==ans) lab.style.color="var(--red)";
  });
}
function markChoicesMulti(container, ansList, picks){
  container.querySelectorAll("label").forEach(l=>l.style.color="var(--sub)");
  container.querySelectorAll("input[type=checkbox]").forEach(i=>{
    const lab = container.querySelector(`label[for="${i.id}"]`);
    if (!lab) return;
    if (ansList.includes(i.value)) lab.style.color="var(--green)";
    if (picks.includes(i.value) && !ansList.includes(i.value)) lab.style.color="var(--red)";
  });
}

/* ---------- grading ---------- */
function submitAll(){
  let got = 0;
  let lines = [];
  RENDER.forEach((m,i)=>{
    const q = QUESTIONS[i];
    const score = m.grade();
    got += score;
    if (!m.counted){ recordAttempt(m.baseId, score >= 1); m.counted = true; }
    const userStr = userAsString(m, q);
    const expectStr = keyAsString(q);
    const status = (q.type==="Matching" ? `${Math.round(score*4)}/4` : (score>=1 ? "CORRECT" : "WRONG"));
    lines.push(`Q${i+1} [${q.type}] -> ${status}\n  Your: ${userStr}\n  Key:  ${expectStr}`);
  });
  const pct = (got / RENDER.length) * 100;
  $("#scoreBox").textContent = `Score: ${got.toFixed(2)}/${RENDER.length}  (${pct.toFixed(1)}%)`;

  const stamp = new Date().toISOString().replace('T',' ').slice(0,19);
  const head = [
    `Exam: ${EXAM_NAME}`,
    `Timestamp: ${stamp}`,
    `Score: ${got.toFixed(2)}/${RENDER.length} (${pct.toFixed(1)}%)`,
    "-".repeat(60)
  ];
  dl(`ExamSim_${Date.now()}.txt`, head.concat(lines).join("\n")+"\n");
}

function userAsString(m, q){
  try{
    if (q.type==="TrueFalse") return (m.getUser()||"(blank)");
    if (q.type==="MultiChoice") return (m.getUser()||"(blank)");
    if (q.type==="MultiSelect"){ const arr = m.getUser(); return arr.length?arr.join(","):"(none)"; }
    if (q.type==="Matching"){ const mm=m.getUser(); return [1,2,3,4].map(n=>`${n}->${mm[n]||"_"}`).join(", "); }
    if (q.type==="ShortAnswer"||q.type==="ProblemScen"){ const u=m.getUser(); return (u.text||"(blank)") + (u.marked?"  [MARKED CORRECT]":""); }
  }catch(e){}
  return "";
}
function keyAsString(q){
  if (q.type==="TrueFalse") return q.answer ? "T" : "F";
  if (q.type==="MultiChoice") return q.answer;
  if (q.type==="MultiSelect") return (q.answer||[]).join(",");
  if (q.type==="Matching") return [1,2,3,4].map(n=>`${n}->${q.answer[n]||q.answer[String(n)]}`).join(", ");
  if (q.type==="ShortAnswer"||q.type==="ProblemScen") return "(manual)";
  return "";
}

/* ---------- file + sample + paste ---------- */
$("#fileInput").addEventListener("change", async (e)=>{
  const f = e.target.files[0]; if (!f) return;
  const txt = await f.text();
  loadYAML(txt, f.name);
});
const pasteArea = $("#yamlPaste"), pasteStatus = $("#pasteStatus");
pasteArea.value = localStorage.getItem(PASTE_KEY) || "";
pasteArea.addEventListener("input", ()=>{
  localStorage.setItem(PASTE_KEY, pasteArea.value);
  pasteArea.classList.remove("error");
  pasteStatus.textContent = pasteArea.value.trim() ? `${pasteArea.value.length} chars` : "";
});
$("#loadFromTextBtn").addEventListener("click", ()=>{
  const text = pasteArea.value.trim();
  if (!text){ pasteArea.classList.add("error"); pasteStatus.textContent = "Paste YAML first."; return; }
  try{
    const parsed = jsyaml.load(text);
    if (!Array.isArray(parsed)) throw new Error("Top-level YAML must be a list.");
    pasteArea.classList.remove("error"); loadYAML(text, "Pasted YAML");
    pasteStatus.textContent = `Loaded ${parsed.length} questions`;
  }catch(err){
    pasteArea.classList.add("error"); pasteStatus.textContent = "YAML error — see alert";
    alert("YAML parse error:\n" + err.message);
  }
});
$("#saveTextBtn").addEventListener("click", ()=> dl("ExamSim_Pasted.yml", pasteArea.value||""));

$("#demoBtn").addEventListener("click", ()=>{
  const sample = `- type: MultiChoice
  text: "Which drug is a direct renin inhibitor?"
  choices: {A: "Lisinopril", B: "Aliskiren", C: "Losartan", D: "Amlodipine"}
  answer: B
  explain: "Aliskiren blocks renin at the start of the RAAS."
- type: TrueFalse
  text: "High-dose loop diuretics can cause ototoxicity."
  answer: true
  explain: "Rapid/high doses can injure the inner ear."
- type: MultiSelect
  text: "Which ACE inhibitors are active (not prodrugs)?"
  choices: {A: "Captopril", B: "Lisinopril", C: "Enalapril", D: "Ramipril"}
  answer: [A, B]
  explain: "Captopril and lisinopril are active; many others are ester prodrugs."
- type: Matching
  text: "Match class → target"
  pairs: {"1":"Loops", "2":"Thiazides", "3":"Amiloride", "4":"Acetazolamide"}
  options: {A:"NCC (DCT)", B:"ENaC (CD)", C:"CA (PCT)", D:"NKCC2 (TAL)"}
  answer: {"1":"D","2":"A","3":"B","4":"C"}
  explain: "Each class hits a signature transporter."
- type: ShortAnswer
  text: "What lab value do you monitor with spironolactone?"
  answer: ""
  explain: "Potassium (risk of hyperkalemia)."
`;
  pasteArea.value = sample; localStorage.setItem(PASTE_KEY, sample);
  pasteStatus.textContent = `${sample.length} chars (sample)`;
  loadYAML(sample, "Demo Exam");
});

  $("#exam5Btn").addEventListener("click", async ()=>{
  try {
    const response = await fetch("exam5.yml");
    if (!response.ok) throw new Error("Could not fetch exam5.yml");
    const yamlText = await response.text();
    pasteArea.value = yamlText;
    localStorage.setItem(PASTE_KEY, yamlText);
    pasteStatus.textContent = `${yamlText.length} chars (Exam5)`;
    loadYAML(yamlText, "Exam5");
  } catch (err) {
    alert("Failed to load Exam5:\n" + err.message);
  }
});


/* ---------- settings ---------- */
$("#applyBtn").addEventListener("click", ()=>{
  SETTINGS.iterations = Math.max(1, Number($("#iterInput").value||3));
  SETTINGS.showAccuracy = $("#accToggle").checked;
  localStorage.setItem(LS_SETTINGS, JSON.stringify(SETTINGS));
  buildDeck(); renderExam();
});
$("#shuffleBtn").addEventListener("click", ()=>{ buildDeck(); renderExam(); });
$("#accToggle").addEventListener("change", ()=>{
  SETTINGS.showAccuracy = $("#accToggle").checked;
  localStorage.setItem(LS_SETTINGS, JSON.stringify(SETTINGS));
  document.querySelectorAll(".acc").forEach(elm => elm.classList.toggle("hide", !SETTINGS.showAccuracy));
});
</script>
</body>
</html>

